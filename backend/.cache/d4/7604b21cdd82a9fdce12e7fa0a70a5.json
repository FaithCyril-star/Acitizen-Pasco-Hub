{"id":"ZEmZ","dependencies":[{"name":"C:\\Users\\ACC\\Desktop\\APH\\Acitizen-Pasco-Hub\\backend\\package.json","includedInParent":true,"mtime":1672218648515},{"name":"../models/courseModel","loc":{"line":1,"column":23,"index":23},"parent":"C:\\Users\\ACC\\Desktop\\APH\\Acitizen-Pasco-Hub\\backend\\controllers\\upload.js","resolved":"C:\\Users\\ACC\\Desktop\\APH\\Acitizen-Pasco-Hub\\backend\\models\\courseModel.js"},{"name":"@azure/storage-blob","loc":{"line":5,"column":12,"index":124},"parent":"C:\\Users\\ACC\\Desktop\\APH\\Acitizen-Pasco-Hub\\backend\\controllers\\upload.js","resolved":"C:\\Users\\ACC\\Desktop\\APH\\Acitizen-Pasco-Hub\\backend\\node_modules\\@azure\\storage-blob\\dist-esm\\storage-blob\\src\\index.browser.js"},{"name":"../config/mongo","loc":{"line":14,"column":8,"index":539},"parent":"C:\\Users\\ACC\\Desktop\\APH\\Acitizen-Pasco-Hub\\backend\\controllers\\upload.js","resolved":"C:\\Users\\ACC\\Desktop\\APH\\Acitizen-Pasco-Hub\\backend\\config\\mongo.js"},{"name":"buffer","parent":"C:\\Users\\ACC\\Desktop\\APH\\Acitizen-Pasco-Hub\\backend\\controllers\\upload.js","resolved":"C:\\Users\\ACC\\AppData\\Roaming\\npm\\node_modules\\parcel-bundler\\node_modules\\buffer\\index.js"}],"generated":{"js":"var Buffer = require(\"buffer\").Buffer;\nvar e=require(\"buffer\").Buffer;const o=require(\"../models/courseModel\"),{BlobServiceClient:n,StorageSharedKeyCredential:t}=require(\"@azure/storage-blob\"),r=\"DefaultEndpointsProtocol=https;AccountName=pascofiles;AccountKey=Tn4NYMzGpEzeprYxhliGxJXfir4qo+wZ5zkSL5IVpEKNNvC48uv8aBYyD1dEx1ue+9dsGZFH0lNt+AStX0Tm1w==;EndpointSuffix=core.windows.net\",i=new t(\"pascofiles\",\"Tn4NYMzGpEzeprYxhliGxJXfir4qo+wZ5zkSL5IVpEKNNvC48uv8aBYyD1dEx1ue+9dsGZFH0lNt+AStX0Tm1w==\");function l(t,l){const{course_name:a,_id:s,uploaded_by:d}=t.body,u=t.file.originalname,c=t.file.size,f=t.file.mimetype,p=e.from(t.file.buffer),m=new n(r,i).getContainerClient(\"files-store\").getBlockBlobClient(u);var S;m.uploadStream(p).then(()=>{S=m.url}).catch(e=>{console.error(e),l.status(500).send(e)});const b={_id:s,uploaded_by:d,name:u,fileUrl:S,size:c,type:f};o.findOneAndUpdate({name:a},{$addToSet:{files:b}},{new:!0}).exec().then(e=>l.json(e)).catch(e=>{l.status(500).send(e)})}require(\"../config/mongo\").connect(),module.exports={add:l};"},"sourceMaps":{"js":{"mappings":[{"source":"controllers/upload.js","original":{"line":71,"column":24},"generated":{"line":2,"column":0}},{"source":"controllers/upload.js","original":{"line":71,"column":24},"generated":{"line":2,"column":4}},{"source":"controllers/upload.js","original":{"line":71,"column":24},"generated":{"line":2,"column":6}},{"source":"controllers/upload.js","original":{"line":71,"column":24},"generated":{"line":2,"column":14}},{"source":"controllers/upload.js","original":{"line":71,"column":24},"generated":{"line":2,"column":24}},{"source":"controllers/upload.js","original":{"line":1,"column":0},"generated":{"line":2,"column":31}},{"source":"controllers/upload.js","name":"Course","original":{"line":1,"column":6},"generated":{"line":2,"column":37}},{"source":"controllers/upload.js","name":"require","original":{"line":1,"column":15},"generated":{"line":2,"column":39}},{"source":"controllers/upload.js","original":{"line":1,"column":23},"generated":{"line":2,"column":47}},{"source":"controllers/upload.js","original":{"line":2,"column":6},"generated":{"line":2,"column":73}},{"source":"controllers/upload.js","name":"BlobServiceClient","original":{"line":3,"column":2},"generated":{"line":2,"column":91}},{"source":"controllers/upload.js","original":{"line":3,"column":19},"generated":{"line":2,"column":93}},{"source":"controllers/upload.js","name":"StorageSharedKeyCredential","original":{"line":4,"column":2},"generated":{"line":2,"column":120}},{"source":"controllers/upload.js","name":"require","original":{"line":5,"column":4},"generated":{"line":2,"column":123}},{"source":"controllers/upload.js","original":{"line":5,"column":12},"generated":{"line":2,"column":131}},{"source":"controllers/upload.js","name":"connectionString","original":{"line":8,"column":6},"generated":{"line":2,"column":154}},{"source":"controllers/upload.js","original":{"line":8,"column":26},"generated":{"line":2,"column":156}},{"source":"controllers/upload.js","name":"sharedKeyCredential","original":{"line":9,"column":6},"generated":{"line":2,"column":344}},{"source":"controllers/upload.js","original":{"line":9,"column":28},"generated":{"line":2,"column":346}},{"source":"controllers/upload.js","name":"StorageSharedKeyCredential","original":{"line":9,"column":32},"generated":{"line":2,"column":350}},{"source":"controllers/upload.js","original":{"line":12,"column":1},"generated":{"line":2,"column":352}},{"source":"controllers/upload.js","original":{"line":12,"column":1},"generated":{"line":2,"column":365}},{"source":"controllers/upload.js","original":{"line":17,"column":0},"generated":{"line":2,"column":457}},{"source":"controllers/upload.js","name":"add","original":{"line":17,"column":9},"generated":{"line":2,"column":466}},{"source":"controllers/upload.js","name":"req","original":{"line":17,"column":13},"generated":{"line":2,"column":468}},{"source":"controllers/upload.js","name":"res","original":{"line":17,"column":17},"generated":{"line":2,"column":470}},{"source":"controllers/upload.js","original":{"line":18,"column":2},"generated":{"line":2,"column":473}},{"source":"controllers/upload.js","original":{"line":18,"column":8},"generated":{"line":2,"column":479}},{"source":"controllers/upload.js","name":"course_name","original":{"line":18,"column":10},"generated":{"line":2,"column":491}},{"source":"controllers/upload.js","original":{"line":18,"column":21},"generated":{"line":2,"column":493}},{"source":"controllers/upload.js","name":"_id","original":{"line":18,"column":23},"generated":{"line":2,"column":497}},{"source":"controllers/upload.js","original":{"line":18,"column":26},"generated":{"line":2,"column":499}},{"source":"controllers/upload.js","name":"uploaded_by","original":{"line":18,"column":28},"generated":{"line":2,"column":511}},{"source":"controllers/upload.js","name":"req","original":{"line":18,"column":44},"generated":{"line":2,"column":514}},{"source":"controllers/upload.js","name":"body","original":{"line":18,"column":48},"generated":{"line":2,"column":516}},{"source":"controllers/upload.js","name":"name","original":{"line":21,"column":8},"generated":{"line":2,"column":521}},{"source":"controllers/upload.js","name":"req","original":{"line":21,"column":15},"generated":{"line":2,"column":523}},{"source":"controllers/upload.js","name":"file","original":{"line":21,"column":19},"generated":{"line":2,"column":525}},{"source":"controllers/upload.js","name":"originalname","original":{"line":21,"column":24},"generated":{"line":2,"column":530}},{"source":"controllers/upload.js","name":"size","original":{"line":22,"column":8},"generated":{"line":2,"column":543}},{"source":"controllers/upload.js","name":"req","original":{"line":22,"column":15},"generated":{"line":2,"column":545}},{"source":"controllers/upload.js","name":"file","original":{"line":22,"column":19},"generated":{"line":2,"column":547}},{"source":"controllers/upload.js","name":"size","original":{"line":22,"column":24},"generated":{"line":2,"column":552}},{"source":"controllers/upload.js","name":"type","original":{"line":23,"column":8},"generated":{"line":2,"column":557}},{"source":"controllers/upload.js","name":"req","original":{"line":23,"column":15},"generated":{"line":2,"column":559}},{"source":"controllers/upload.js","name":"file","original":{"line":23,"column":19},"generated":{"line":2,"column":561}},{"source":"controllers/upload.js","name":"mimetype","original":{"line":23,"column":24},"generated":{"line":2,"column":566}},{"source":"controllers/upload.js","name":"file","original":{"line":24,"column":8},"generated":{"line":2,"column":575}},{"source":"controllers/upload.js","name":"Buffer","original":{"line":24,"column":15},"generated":{"line":2,"column":577}},{"source":"controllers/upload.js","name":"from","original":{"line":24,"column":22},"generated":{"line":2,"column":579}},{"source":"controllers/upload.js","name":"req","original":{"line":24,"column":27},"generated":{"line":2,"column":584}},{"source":"controllers/upload.js","name":"file","original":{"line":24,"column":31},"generated":{"line":2,"column":586}},{"source":"controllers/upload.js","name":"buffer","original":{"line":24,"column":36},"generated":{"line":2,"column":591}},{"source":"controllers/upload.js","name":"blockBlobClient","original":{"line":38,"column":8},"generated":{"line":2,"column":599}},{"source":"controllers/upload.js","original":{"line":27,"column":28},"generated":{"line":2,"column":601}},{"source":"controllers/upload.js","name":"BlobServiceClient","original":{"line":27,"column":32},"generated":{"line":2,"column":605}},{"source":"controllers/upload.js","name":"connectionString","original":{"line":28,"column":4},"generated":{"line":2,"column":607}},{"source":"controllers/upload.js","name":"sharedKeyCredential","original":{"line":29,"column":4},"generated":{"line":2,"column":609}},{"source":"controllers/upload.js","name":"getContainerClient","original":{"line":33,"column":44},"generated":{"line":2,"column":612}},{"source":"controllers/upload.js","original":{"line":35,"column":3},"generated":{"line":2,"column":631}},{"source":"controllers/upload.js","name":"getBlockBlobClient","original":{"line":38,"column":42},"generated":{"line":2,"column":646}},{"source":"controllers/upload.js","name":"name","original":{"line":38,"column":61},"generated":{"line":2,"column":665}},{"source":"controllers/upload.js","original":{"line":41,"column":2},"generated":{"line":2,"column":668}},{"source":"controllers/upload.js","name":"fileUrl","original":{"line":41,"column":6},"generated":{"line":2,"column":672}},{"source":"controllers/upload.js","name":"blockBlobClient","original":{"line":42,"column":2},"generated":{"line":2,"column":674}},{"source":"controllers/upload.js","name":"uploadStream","original":{"line":43,"column":5},"generated":{"line":2,"column":676}},{"source":"controllers/upload.js","name":"file","original":{"line":43,"column":18},"generated":{"line":2,"column":689}},{"source":"controllers/upload.js","name":"then","original":{"line":44,"column":5},"generated":{"line":2,"column":692}},{"source":"controllers/upload.js","original":{"line":44,"column":10},"generated":{"line":2,"column":697}},{"source":"controllers/upload.js","name":"fileUrl","original":{"line":46,"column":6},"generated":{"line":2,"column":702}},{"source":"controllers/upload.js","name":"blockBlobClient","original":{"line":46,"column":16},"generated":{"line":2,"column":704}},{"source":"controllers/upload.js","name":"url","original":{"line":46,"column":32},"generated":{"line":2,"column":706}},{"source":"controllers/upload.js","name":"catch","original":{"line":51,"column":5},"generated":{"line":2,"column":712}},{"source":"controllers/upload.js","name":"err","original":{"line":51,"column":12},"generated":{"line":2,"column":718}},{"source":"controllers/upload.js","name":"console","original":{"line":52,"column":6},"generated":{"line":2,"column":722}},{"source":"controllers/upload.js","name":"error","original":{"line":52,"column":14},"generated":{"line":2,"column":730}},{"source":"controllers/upload.js","name":"err","original":{"line":52,"column":20},"generated":{"line":2,"column":736}},{"source":"controllers/upload.js","name":"res","original":{"line":53,"column":6},"generated":{"line":2,"column":739}},{"source":"controllers/upload.js","name":"status","original":{"line":53,"column":10},"generated":{"line":2,"column":741}},{"source":"controllers/upload.js","original":{"line":53,"column":17},"generated":{"line":2,"column":748}},{"source":"controllers/upload.js","name":"send","original":{"line":53,"column":22},"generated":{"line":2,"column":753}},{"source":"controllers/upload.js","name":"err","original":{"line":53,"column":27},"generated":{"line":2,"column":758}},{"source":"controllers/upload.js","original":{"line":57,"column":2},"generated":{"line":2,"column":763}},{"source":"controllers/upload.js","name":"newFile","original":{"line":57,"column":8},"generated":{"line":2,"column":769}},{"source":"controllers/upload.js","original":{"line":57,"column":18},"generated":{"line":2,"column":771}},{"source":"controllers/upload.js","name":"_id","original":{"line":57,"column":20},"generated":{"line":2,"column":772}},{"source":"controllers/upload.js","name":"_id","original":{"line":57,"column":20},"generated":{"line":2,"column":776}},{"source":"controllers/upload.js","name":"uploaded_by","original":{"line":57,"column":25},"generated":{"line":2,"column":778}},{"source":"controllers/upload.js","name":"uploaded_by","original":{"line":57,"column":25},"generated":{"line":2,"column":790}},{"source":"controllers/upload.js","name":"name","original":{"line":57,"column":38},"generated":{"line":2,"column":792}},{"source":"controllers/upload.js","name":"name","original":{"line":57,"column":38},"generated":{"line":2,"column":797}},{"source":"controllers/upload.js","name":"fileUrl","original":{"line":57,"column":44},"generated":{"line":2,"column":799}},{"source":"controllers/upload.js","name":"fileUrl","original":{"line":57,"column":44},"generated":{"line":2,"column":807}},{"source":"controllers/upload.js","name":"size","original":{"line":57,"column":53},"generated":{"line":2,"column":809}},{"source":"controllers/upload.js","name":"size","original":{"line":57,"column":53},"generated":{"line":2,"column":814}},{"source":"controllers/upload.js","name":"type","original":{"line":57,"column":59},"generated":{"line":2,"column":816}},{"source":"controllers/upload.js","name":"type","original":{"line":57,"column":59},"generated":{"line":2,"column":821}},{"source":"controllers/upload.js","name":"Course","original":{"line":58,"column":16},"generated":{"line":2,"column":824}},{"source":"controllers/upload.js","name":"findOneAndUpdate","original":{"line":58,"column":23},"generated":{"line":2,"column":826}},{"source":"controllers/upload.js","original":{"line":59,"column":4},"generated":{"line":2,"column":843}},{"source":"controllers/upload.js","name":"name","original":{"line":59,"column":6},"generated":{"line":2,"column":844}},{"source":"controllers/upload.js","name":"course_name","original":{"line":59,"column":12},"generated":{"line":2,"column":849}},{"source":"controllers/upload.js","original":{"line":60,"column":4},"generated":{"line":2,"column":852}},{"source":"controllers/upload.js","name":"$addToSet","original":{"line":60,"column":6},"generated":{"line":2,"column":853}},{"source":"controllers/upload.js","original":{"line":60,"column":17},"generated":{"line":2,"column":863}},{"source":"controllers/upload.js","name":"files","original":{"line":60,"column":19},"generated":{"line":2,"column":864}},{"source":"controllers/upload.js","name":"newFile","original":{"line":60,"column":26},"generated":{"line":2,"column":870}},{"source":"controllers/upload.js","original":{"line":61,"column":4},"generated":{"line":2,"column":874}},{"source":"controllers/upload.js","name":"new","original":{"line":61,"column":6},"generated":{"line":2,"column":875}},{"source":"controllers/upload.js","original":{"line":61,"column":11},"generated":{"line":2,"column":880}},{"source":"controllers/upload.js","name":"exec","original":{"line":64,"column":5},"generated":{"line":2,"column":884}},{"source":"controllers/upload.js","name":"then","original":{"line":65,"column":5},"generated":{"line":2,"column":891}},{"source":"controllers/upload.js","name":"doc","original":{"line":65,"column":11},"generated":{"line":2,"column":896}},{"source":"controllers/upload.js","name":"res","original":{"line":65,"column":19},"generated":{"line":2,"column":899}},{"source":"controllers/upload.js","name":"json","original":{"line":65,"column":23},"generated":{"line":2,"column":901}},{"source":"controllers/upload.js","name":"doc","original":{"line":65,"column":28},"generated":{"line":2,"column":906}},{"source":"controllers/upload.js","name":"catch","original":{"line":66,"column":5},"generated":{"line":2,"column":910}},{"source":"controllers/upload.js","name":"err","original":{"line":66,"column":12},"generated":{"line":2,"column":916}},{"source":"controllers/upload.js","name":"res","original":{"line":67,"column":6},"generated":{"line":2,"column":920}},{"source":"controllers/upload.js","name":"status","original":{"line":67,"column":10},"generated":{"line":2,"column":922}},{"source":"controllers/upload.js","original":{"line":67,"column":17},"generated":{"line":2,"column":929}},{"source":"controllers/upload.js","name":"send","original":{"line":67,"column":22},"generated":{"line":2,"column":934}},{"source":"controllers/upload.js","name":"err","original":{"line":67,"column":27},"generated":{"line":2,"column":939}},{"source":"controllers/upload.js","name":"require","original":{"line":14,"column":0},"generated":{"line":2,"column":944}},{"source":"controllers/upload.js","original":{"line":14,"column":8},"generated":{"line":2,"column":952}},{"source":"controllers/upload.js","name":"connect","original":{"line":14,"column":27},"generated":{"line":2,"column":971}},{"source":"controllers/upload.js","name":"module","original":{"line":71,"column":0},"generated":{"line":2,"column":981}},{"source":"controllers/upload.js","name":"exports","original":{"line":71,"column":7},"generated":{"line":2,"column":988}},{"source":"controllers/upload.js","original":{"line":71,"column":17},"generated":{"line":2,"column":996}},{"source":"controllers/upload.js","name":"add","original":{"line":71,"column":19},"generated":{"line":2,"column":997}},{"source":"controllers/upload.js","name":"add","original":{"line":71,"column":19},"generated":{"line":2,"column":1001}}],"sources":{"controllers/upload.js":"const Course = require(\"../models/courseModel\");\r\nconst {\r\n  BlobServiceClient,\r\n  StorageSharedKeyCredential,\r\n} = require(\"@azure/storage-blob\");\r\n\r\n// Set the connection string and shared key credentials for the storage account\r\nconst connectionString = `DefaultEndpointsProtocol=https;AccountName=${process.env.STORAGE_ACCOUNT};AccountKey=${process.env.STORAGE_KEY};EndpointSuffix=core.windows.net`;\r\nconst sharedKeyCredential = new StorageSharedKeyCredential(\r\n  process.env.STORAGE_ACCOUNT,\r\n  process.env.STORAGE_KEY\r\n);\r\n\r\nrequire(\"../config/mongo\").connect();\r\n\r\n//creating endpoint to add a file to a course\r\nfunction add(req,res){\r\n  const { course_name, _id, uploaded_by } = req.body;\r\n\r\n  // Read the contents of the file into a buffer and it's other properties\r\n  const name = req.file.originalname;\r\n  const size = req.file.size;\r\n  const type = req.file.mimetype;\r\n  const file = Buffer.from(req.file.buffer);\r\n\r\n  // Create a new BlobServiceClient using the connection string and shared key credentials\r\n  const blobServiceClient = new BlobServiceClient(\r\n    connectionString,\r\n    sharedKeyCredential\r\n  );\r\n\r\n  // Get a reference to the container where the file will be stored\r\n  const containerClient = blobServiceClient.getContainerClient(\r\n    process.env.STORAGE_CONTAINER\r\n  );\r\n\r\n  // Create a new block blob client for the file\r\n  const blockBlobClient = containerClient.getBlockBlobClient(name);\r\n\r\n  // Upload the file to Azure Blob Storage\r\n  var fileUrl;\r\n  blockBlobClient\r\n    .uploadStream(file)\r\n    .then(() => {\r\n      // Get the URL of the stored file\r\n      fileUrl = blockBlobClient.url;\r\n\r\n      // console.log(`File stored at ${fileUrl}`);\r\n      // res.send(fileUrl);\r\n    })\r\n    .catch((err) => {\r\n      console.error(err);\r\n      res.status(500).send(err);\r\n    });\r\n\r\n  //new file object to be added to course\r\n  const newFile = { _id, uploaded_by, name, fileUrl, size, type };\r\n  const query = Course.findOneAndUpdate(\r\n    { name: course_name },\r\n    { $addToSet: { files: newFile } },\r\n    { new: true }\r\n  );\r\n  query\r\n    .exec()\r\n    .then((doc) => res.json(doc))\r\n    .catch((err) => {\r\n      res.status(500).send(err);\r\n    });\r\n}\r\n\r\nmodule.exports = { add };\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n"},"lineCount":null}},"error":null,"hash":"e08bc2386dbe331c79b6d4d83360b1c7","cacheData":{"env":{"STORAGE_ACCOUNT":"pascofiles","STORAGE_KEY":"Tn4NYMzGpEzeprYxhliGxJXfir4qo+wZ5zkSL5IVpEKNNvC48uv8aBYyD1dEx1ue+9dsGZFH0lNt+AStX0Tm1w==","STORAGE_CONTAINER":"files-store"}}}